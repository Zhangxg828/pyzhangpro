# ZhangXingguang_Flight_Dash_V10.6_MAX 部署和使用说明书

## 一、系统概述

本系统是一个增强型量化交易仪表盘，具有以下核心功能：

- **实时市场数据获取**：直接从 Binance API 获取实时行情数据
- **技术指标分析**：计算 SAR、RSI、MACD、布林带等技术指标
- **风险管理**：实时监控风险水平，提供风险预警
- **市场环境识别**：识别牛市、熊市、震荡市等市场环境
- **流动性分析**：评估市场流动性和深度
- **异常检测**：检测价格异常、成交量异常等市场异常
- **AI 智能分析**：集成 AI 模型进行市场分析和预测
- **数据持久化**：将分析结果保存到数据库

## 二、环境要求

### 2.1 硬件要求
- CPU: 4 核心以上
- 内存: 8GB 以上
- 硬盘: 10GB 以上可用空间
- 网络: 稳定的互联网连接（用于访问 Binance API）

### 2.2 软件要求
- 操作系统: Ubuntu 20.04+ / macOS / Linux / Windows
- Python: 3.9 或更高版本
- pip: Python 包管理器

### 2.3 Ubuntu 系统特殊要求
如果使用 Ubuntu 系统，需要确保以下软件包已安装：

```bash
# 更新系统包
sudo apt update

# 安装 Python 和 pip
sudo apt install python3 python3-pip python3-venv

# 安装必要的系统依赖
sudo apt install build-essential libssl-dev libffi-dev python3-dev

# 如果需要使用代理，安装必要的工具
sudo apt install proxychains4
```

### 2.4 依赖包
系统需要以下 Python 包：
- requests: HTTP 请求库
- openai: OpenAI API 客户端
- numpy: 数值计算库
- pandas: 数据分析库
- scikit-learn: 机器学习库
- colorama: 终端颜色输出

## 三、安装步骤

### 3.1 克隆或下载项目代码

```bash
cd /path/to/your/workspace
# 如果使用 git
git clone <repository-url>
cd py

# 或者直接解压项目文件到指定目录
```

### 3.2 创建虚拟环境（推荐）

```bash
# macOS/Linux
python3 -m venv .venv
source .venv/bin/activate

# Windows
python -m venv .venv
.venv\Scripts\activate
```

### 3.3 安装依赖包

```bash
pip install requests openai numpy pandas scikit-learn colorama
```

### 3.4 验证安装

```bash
python3 -c "import requests, openai, numpy, pandas, sklearn, colorama; print('所有依赖包安装成功')"
```

## 四、配置说明

### 4.1 环境变量配置

系统支持通过环境变量进行配置，主要配置项如下：

```bash
# 数据库路径（可选，默认使用相对路径 ./data/）
# 数据库会自动在当前脚本文件夹下的 data 目录中创建
export DB_MEMORY=./data/market_memory.db
export DB_VERIFY=./data/verification_pro.db

# VLLM API 配置（用于 AI 分析）
export VLLM_API=http://localhost:8000/v1
export MODEL_NAME=/models

# 代理配置（可选，用于访问 Binance API）
# 格式: http://proxy_ip:port 或 socks5://proxy_ip:port
# 示例: export PROXY_URL=socks5://127.0.0.1:1080
export PROXY_URL=

# 日志级别（DEBUG, INFO, WARNING, ERROR）
export LOG_LEVEL=INFO

# 通知配置（可选）
export DINGTALK_WEBHOOK=your_dingtalk_webhook_url
export TELEGRAM_API_ID=your_telegram_api_id
export TELEGRAM_API_HASH=your_telegram_api_hash
```

### 4.2 配置文件

主要配置文件为 `config.py`，包含以下配置项：

- **数据库配置**: DB_MEMORY, DB_VERIFY
- **API 配置**: VLLM_API, MODEL_NAME
- **风险控制配置**: RISK_CONTROL_CONFIG
- **技术指标配置**: TECHNICAL_INDICATORS_CONFIG
- **市场环境配置**: MARKET_REGIME_CONFIG
- **流动性管理配置**: LIQUIDITY_MANAGER_CONFIG
- **情绪分析配置**: SENTIMENT_ANALYSIS_CONFIG
- **异常检测配置**: ANOMALY_DETECTION_CONFIG

### 4.3 数据目录结构

```
py/
├── data/                          # 数据目录
│   ├── market_memory.db           # 市场数据数据库
│   ├── verification_pro.db        # 验证数据库
│   ├── flight_dash.log            # 仪表盘日志
│   └── system.log                 # 系统日志
├── config.py                      # 配置文件
├── ZhangXingguang_Flight_Dash_V10.6_MAX.py  # 主程序
├── init_verification_db.py        # 数据库初始化脚本
├── risk_manager.py                # 风险管理模块
├── technical_indicators.py        # 技术指标模块
├── market_regime_detector.py      # 市场环境识别模块
├── liquidity_manager.py           # 流动性管理模块
├── advanced_sentiment_analyzer.py # 情绪分析模块
└── anomaly_detector.py            # 异常检测模块
```

## 五、启动步骤

### 5.1 首次部署 - 初始化数据库

```bash
# 激活虚拟环境
source .venv/bin/activate

# 初始化数据库
python3 init_verification_db.py
```

成功后会显示：
```
✅ verification_pro.db 初始化成功: /path/to/verification_pro.db
✅ 数据库初始化完成
```

### 5.2 启动主程序

```bash
# 方式一：直接运行
python3 ZhangXingguang_Flight_Dash_V10.6_MAX.py

# 方式二：后台运行（Linux/macOS）
nohup python3 ZhangXingguang_Flight_Dash_V10.6_MAX.py > output.log 2>&1 &

# 方式三：使用 screen/tmux
screen -S flight_dash
python3 ZhangXingguang_Flight_Dash_V10.6_MAX.py
# 按 Ctrl+A+D 分离会话
```

### 5.3 验证启动

启动成功后会看到以下日志：
```
2026-01-04 20:33:02 - risk_manager - INFO - 风险管理器初始化完成 - 最大回撤:15.0%, 单笔止损:2.0%
2026-01-04 20:33:02 - technical_indicators - INFO - 技术指标扩展模块初始化完成
2026-01-04 20:33:02 - market_regime_detector - INFO - 市场环境识别器初始化完成 - 牛市阈值:2.0%, 熊市阈值:-2.0%
2026-01-04 20:33:02 - liquidity_manager - INFO - 流动性管理器初始化完成 - 最小深度:100000, 最大滑点:0.5%
2026-01-04 20:33:02 - advanced_sentiment_analyzer - INFO - 高级情绪分析器初始化完成
2026-01-04 20:33:02 - anomaly_detector - INFO - 异常检测器初始化完成
2026-01-04 20:33:02 - flight_dash - INFO - 所有风险管理和技术分析模块已初始化
2026-01-04 20:33:02 - flight_dash - INFO - 市场数据获取器已初始化
2026-01-04 20:33:02 - flight_dash - INFO - 交易仪表盘启动
```

## 六、使用说明

### 6.1 系统运行模式

系统启动后会自动进入循环运行模式，主要流程：

1. **市场数据获取**: 从 Binance API 获取实时行情数据
2. **技术指标计算**: 计算 SAR、RSI、MACD 等技术指标
3. **风险分析**: 评估当前风险水平
4. **市场环境识别**: 识别牛市/熊市/震荡市
5. **流动性分析**: 评估市场流动性
6. **异常检测**: 检测市场异常
7. **AI 分析**: 使用 AI 模型进行深度分析（如果配置了 VLLM API）
8. **结果保存**: 将分析结果保存到数据库
9. **显示更新**: 更新终端显示

### 6.2 监控交易对

系统默认监控以下交易对（可在 config.py 的 CRYPTO_LIST 中修改）：
- BTC/USDT, ETH/USDT, BNB/USDT, SOL/USDT, XRP/USDT
- ADA/USDT, DOGE/USDT, AVAX/USDT, DOT/USDT, MATIC/USDT

### 6.3 查看实时数据

#### 方式一：查看终端输出
系统会在终端实时显示市场数据和分析结果

#### 方式二：查看日志文件
```bash
# 查看仪表盘日志
tail -f data/flight_dash.log

# 查看系统日志
tail -f data/system.log
```

#### 方式三：查询数据库
```bash
# 查看最新的分析结果
sqlite3 data/verification_pro.db "SELECT * FROM analysis_results ORDER BY timestamp DESC LIMIT 10;"

# 查看特定交易对的历史数据
sqlite3 data/verification_pro.db "SELECT * FROM analysis_results WHERE symbol='BTCUSDT' ORDER BY timestamp DESC LIMIT 20;"

# 查看统计信息
sqlite3 data/verification_pro.db "SELECT symbol, COUNT(*) as count, AVG(price) as avg_price FROM analysis_results GROUP BY symbol;"
```

### 6.4 停止系统

```bash
# 如果在前台运行，按 Ctrl+C

# 如果在后台运行，找到进程并终止
ps aux | grep ZhangXingguang_Flight_Dash
kill <PID>

# 如果使用 screen
screen -r flight_dash
# 按 Ctrl+C 停止程序
# 按 Ctrl+A+D 退出 screen

# 如果使用 tmux
tmux attach -t flight_dash
# 按 Ctrl+C 停止程序
# 按 Ctrl+B+D 分离会话
```

## 七、监控和维护

### 7.1 日志监控

```bash
# 实时查看日志
tail -f data/flight_dash.log

# 查看错误日志
grep ERROR data/flight_dash.log

# 查看最近的日志
tail -100 data/flight_dash.log
```

### 7.2 数据库维护

```bash
# 检查数据库完整性
sqlite3 data/verification_pro.db "PRAGMA integrity_check;"
sqlite3 data/market_memory.db "PRAGMA integrity_check;"

# 备份数据库
cp data/verification_pro.db data/verification_pro.db.backup
cp data/market_memory.db data/market_memory.db.backup

# 清理旧数据（保留最近 7 天）
sqlite3 data/verification_pro.db "DELETE FROM analysis_results WHERE timestamp < datetime('now', '-7 days');"
```

### 7.3 性能监控

```bash
# 查看系统资源使用
top -p $(pgrep -f ZhangXingguang_Flight_Dash)

# 查看网络连接
netstat -an | grep api.binance.com

# 查看磁盘使用
df -h data/
```

### 7.4 定期任务建议

建议设置以下定期任务：

1. **每日备份数据库**
```bash
# 添加到 crontab
0 2 * * * cp /path/to/data/verification_pro.db /path/to/backups/verification_pro_$(date +\%Y\%m\%d).db
```

2. **每周清理旧日志**
```bash
# 添加到 crontab
0 3 * * 0 find /path/to/data -name "*.log" -mtime +7 -delete
```

3. **每月检查数据库大小**
```bash
# 添加到 crontab
0 4 1 * * du -sh /path/to/data/*.db
```

## 八、常见问题

### 8.1 启动失败

**问题**: ModuleNotFoundError: No module named 'xxx'

**解决方案**:
```bash
pip install xxx
# 或重新安装所有依赖
pip install -r requirements.txt
```

**问题**: 数据库连接错误

**解决方案**:
```bash
# 检查数据库文件是否存在
ls -la data/

# 重新初始化数据库
python3 init_verification_db.py
```

### 8.2 API 连接问题

**问题**: 获取行情失败: HTTPSConnectionPool timeout

**解决方案**:
- 检查网络连接
- 检查防火墙设置
- 检查 Binance API 是否正常访问
```bash
curl -I https://api.binance.com/api/v3/ping
```

**问题**: Connection reset by peer

**解决方案**:
- 检查网络稳定性
- 增加请求超时时间（修改代码中的 timeout 参数）
- 使用代理（如果需要）

### 8.3 数据库问题

**问题**: disk I/O error

**解决方案**:
```bash
# 清理 WAL 文件
rm -f data/*.db-shm data/*.db-wal

# 检查磁盘空间
df -h data/

# 修复数据库
sqlite3 data/verification_pro.db "PRAGMA integrity_check;"
```

**问题**: no such table: xxx

**解决方案**:
```bash
# 重新初始化数据库
python3 init_verification_db.py
```

### 8.4 性能问题

**问题**: 系统运行缓慢

**解决方案**:
- 检查系统资源使用情况
- 减少监控的交易对数量
- 调整数据更新频率
- 优化数据库查询

**问题**: 内存占用过高

**解决方案**:
- 定期清理旧数据
- 调整缓存大小
- 重启程序

### 8.5 AI 分析问题

**问题**: AI 推理异常: Error code: 502

**解决方案**:
- 检查 VLLM API 服务是否正常运行
- 检查 VLLM_API 配置是否正确
- 检查网络连接
```bash
curl http://localhost:8000/v1/models
```

## 九、高级配置

### 9.1 修改监控的交易对

编辑 `config.py` 文件，修改 `CRYPTO_LIST`：

```python
CRYPTO_LIST = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT', 'XRP/USDT']
```

### 9.2 调整风险参数

编辑 `config.py` 文件，修改 `RISK_CONTROL_CONFIG`：

```python
RISK_CONTROL_CONFIG = {
    'max_drawdown': 0.15,        # 最大回撤 15%
    'max_position_size': 0.1,    # 最大持仓 10%
    'max_single_loss': 0.02,     # 单笔止损 2%
    'daily_loss_limit': 0.05,    # 日损失限制 5%
}
```

### 9.3 调整技术指标参数

编辑 `config.py` 文件，修改 `TECHNICAL_INDICATORS_CONFIG`：

```python
TECHNICAL_INDICATORS_CONFIG = {
    'atr_period': 14,             # ATR 周期
    'rsi_period': 14,             # RSI 周期
    'rsi_overbought': 70,         # RSI 超买线
    'rsi_oversold': 30,           # RSI 超卖线
    'macd_fast': 12,              # MACD 快线
    'macd_slow': 26,              # MACD 慢线
}
```

### 9.4 配置通知

编辑 `config.py` 文件或设置环境变量：

```bash
export DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxx
export TELEGRAM_API_ID=your_api_id
export TELEGRAM_API_HASH=your_api_hash
```

## 十、安全建议

1. **保护配置文件**: 不要将包含敏感信息的配置文件提交到版本控制系统
2. **定期备份**: 定期备份数据库和配置文件
3. **访问控制**: 限制对数据库和日志文件的访问权限
4. **网络安全**: 使用防火墙限制不必要的网络访问
5. **日志审计**: 定期检查日志文件，发现异常行为

## 十一、联系支持

如遇到问题，请提供以下信息：
- 操作系统版本
- Python 版本
- 错误日志
- 配置文件（隐藏敏感信息）
- 复现步骤

---

**版本**: V10.6_MAX
**更新日期**: 2026-01-04
**维护者**: ZhangXingguang
